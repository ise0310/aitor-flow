<!doctype html>
<html lang="ko"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AITOR — 개인화 코스</title>
<style>
  body { font-family: Inter, system-ui, sans-serif; max-width: 960px; margin: 28px auto; padding: 0 16px; }
  pre { background:#0f172a; color:#e2e8f0; padding:12px; border-radius:10px; overflow:auto; }
  button { padding:8px 10px; font-size:14px; }
</style>
</head>
<body>
<h1>개인화 코스 생성 결과</h1>
<button id="regen">다시 생성</button>
<pre id="out">생성 중...</pre>
<script>
async function gen() {
  const profile = JSON.parse(localStorage.getItem('aitor_profile') || '{}');
  const character_id = localStorage.getItem('aitor_character') || 'alex';
  const level = JSON.parse(localStorage.getItem('aitor_level') || '{}');
  // 시험일까지 자동 계산을 위해 today는 클라이언트 날짜 사용
  const today = new Date().toISOString().slice(0,10);
  const payload = { character_id, today, student_profile: {
    exam: "TOEFL",
    exam_date: inferExamDate(profile.time_left),
    time: { per_week_hours: guessHours(profile.time_left), session_length_min: 40 },
    weak_topics: deriveWeakTopics(level),
    baseline: deriveBaseline(level),
    preferences: { mode: "practice", language: "ko", gamify: true }
  } };
  const r = await fetch('/api/generate-plan', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  const data = await r.json();
  document.getElementById('out').textContent = JSON.stringify(data.plan_json || data.raw || data, null, 2);
}
function inferExamDate(time_left) {
  const d = new Date();
  if (time_left==='2w') d.setDate(d.getDate()+14);
  else if (time_left==='1m') d.setMonth(d.getMonth()+1);
  else if (time_left==='3m') d.setMonth(d.getMonth()+3);
  else d.setMonth(d.getMonth()+6);
  return d.toISOString().slice(0,10);
}
function guessHours(time_left) {
  if (time_left==='2w') return 5; if (time_left==='1m') return 6; if (time_left==='3m') return 7; return 6;
}
function deriveWeakTopics(level) {
  const arr = [];
  if (level?.reading?.correct < 2) arr.push('R-inference');
  if ((level?.speaking?.score||0) < 3.5) arr.push('S-cohesion');
  return arr.length?arr:['R-inference'];
}
function deriveBaseline(level) {
  const R = (level?.reading?.correct||0) * 10 + 10;
  const S = Math.round(((level?.speaking?.score||0) / 4) * 25);
  return { R, S };
}
document.getElementById('regen').onclick = gen;
gen();
</script>
</body></html>
